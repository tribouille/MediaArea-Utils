#!/bin/sh

test_with_curl()
{
    ANSWER=`curl -s "$1"`
    ./validate_json.py "$ANSWER" "$2"
    if test $? -eq 0; then
        echo "$3";
    else
        echo "command $1 failed"
        echo "$ANSWER"
        exit 1;
    fi;
    ANSWER=
}

test_with_curl_data()
{
    ANSWER=`curl -s -X POST -H "Content-Type: application/json" -d "$2" "$1"`
    if test $? -ne 0; then
        echo "command $1 failed"
        exit 1;
    fi;

    ./validate_json.py "$ANSWER" "$3"
    if test $? -eq 0; then
        echo "$4";
    else
        echo "command $1 failed"
        echo "$ANSWER"
        exit 1;
    fi;
    ANSWER=
}

#create XSLT policy (X2)
#get policies and policies count
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 1}}' "pass get policies count"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies" "{\"POLICY_GET_POLICIES_RESULT\": {\"policies\": [{\"children\": [{\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc height\", \"id\": 0, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"486\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc-ish height\", \"id\": 1, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"480\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"half-ntsc height\", \"id\": 2, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"240\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"I like frame heights like 240, 480, 486\", \"id\": 2, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 3, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}, {\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 4, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"30000\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 5, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1001\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"NTSC 4EVA\", \"id\": 4, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 6, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"2997\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 7, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"100\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Or Fake NTSC\", \"id\": 5, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 8, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"25\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 9, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"PAL, why not\", \"id\": 6, \"kind\": \"XSLT\", \"parent_id\": 3}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"These are the framerates that I trust\", \"id\": 3, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"children\": [{\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 10, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"720\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 11, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"640\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 12, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"Frames widths like 720, 640, and 320 are nice\", \"id\": 7, \"kind\": \"XSLT\", \"parent_id\": 1}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Does this use framesize and framerates that I like?\", \"id\": 1, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"children\": [{\"ope\": \"<=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 13, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.5\"}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 14, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"In my aspect ratio zone?\", \"id\": 8, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 15, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\", \"type\": \"or\", \"name\": \"Do I like these frames?\", \"id\": 0, \"kind\": \"XSLT\", \"parent_id\": -1}]}}" "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?user=1" "{\"POLICY_GET_POLICIES_RESULT\": {\"policies\": [{\"children\": [{\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc height\", \"id\": 0, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"486\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc-ish height\", \"id\": 1, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"480\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"half-ntsc height\", \"id\": 2, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"240\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"I like frame heights like 240, 480, 486\", \"id\": 2, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 3, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}, {\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 4, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"30000\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 5, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1001\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"NTSC 4EVA\", \"id\": 4, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 6, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"2997\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 7, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"100\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Or Fake NTSC\", \"id\": 5, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 8, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"25\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 9, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"PAL, why not\", \"id\": 6, \"kind\": \"XSLT\", \"parent_id\": 3}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"These are the framerates that I trust\", \"id\": 3, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"children\": [{\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 10, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"720\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 11, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"640\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 12, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"Frames widths like 720, 640, and 320 are nice\", \"id\": 7, \"kind\": \"XSLT\", \"parent_id\": 1}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Does this use framesize and framerates that I like?\", \"id\": 1, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"children\": [{\"ope\": \"<=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 13, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.5\"}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 14, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"In my aspect ratio zone?\", \"id\": 8, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 15, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\", \"type\": \"or\", \"name\": \"Do I like these frames?\", \"id\": 0, \"kind\": \"XSLT\", \"parent_id\": -1}]}}" "pass get policies"

test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create" '{"XSLT_POLICY_CREATE_RESULT": {"id": 9}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get?id=9" '{"POLICY_GET_RESULT": {"policy": {"type": "and", "id": 9, "description": "", "parent_id": -1, "name": "New policy", "kind": "XSLT", "is_system": false, "children":[]}}}' "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies" "{\"POLICY_GET_POLICIES_RESULT\": {\"policies\": [{\"children\": [{\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc height\", \"id\": 0, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"486\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc-ish height\", \"id\": 1, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"480\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"half-ntsc height\", \"id\": 2, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"240\"}], \"is_system\":true, \"description\": \"\", \"type\": \"or\", \"name\": \"I like frame heights like 240, 480, 486\", \"id\": 2, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 3, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}, {\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 4, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"30000\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 5, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1001\"}], \"is_system\":true, \"description\": \"\", \"type\": \"and\", \"name\": \"NTSC 4EVA\", \"id\": 4, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 6, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"2997\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 7, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"100\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Or Fake NTSC\", \"id\": 5, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 8, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"25\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 9, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"PAL, why not\", \"id\": 6, \"kind\": \"XSLT\", \"parent_id\": 3}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"These are the framerates that I trust\", \"id\": 3, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"children\": [{\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 10, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"720\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 11, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"640\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 12, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"Frames widths like 720, 640, and 320 are nice\", \"id\": 7, \"kind\": \"XSLT\", \"parent_id\": 1}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Does this use framesize and framerates that I like?\", \"id\": 1, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"children\": [{\"ope\": \"<=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 13, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.5\"}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 14, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"In my aspect ratio zone?\", \"id\": 8, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 15, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\", \"type\": \"or\", \"name\": \"Do I like these frames?\", \"id\": 0, \"kind\": \"XSLT\", \"parent_id\": -1},{\"type\": \"and\", \"id\": 9, \"description\": \"\", \"parent_id\": -1, \"name\": \"New policy\", \"kind\": \"XSLT\", \"is_system\": false, \"children\":[]}]}}" "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 2}}' "pass get policies count"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create" '{"XSLT_POLICY_CREATE_RESULT": {"id": 10}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 3}}' "pass get policies count"

#save policy
test_with_curl "http://0.0.0.0:4242/1.7/policy_save?id=9" '{"POLICY_SAVE_RESULT": {}}' "pass save policy"

#get/set policy name
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_name?id=9" '{"POLICY_GET_NAME_RESULT": {"name": "New policy"}}' "pass get name"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_name?id=10" '{"POLICY_GET_NAME_RESULT": {"name": "New policy 1"}}' "pass get name"
test_with_curl_data "http://0.0.0.0:4242/1.7/policy_change_info" '{"POLICY_CHANGE_INFO":{"id": 9, "name": "changed name", "description": "changed description"}}' '{"POLICY_CHANGE_INFO_RESULT": {}}' "pass change info"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_name?id=9" '{"POLICY_GET_NAME_RESULT": {"name": "changed name"}}' "pass get name"
test_with_curl_data "http://0.0.0.0:4242/1.7/policy_change_type" '{"POLICY_CHANGE_TYPE":{"id": 9, "type": "or"}}' '{"POLICY_CHANGE_TYPE_RESULT": {}}' "pass change type"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies" "{\"POLICY_GET_POLICIES_RESULT\": {\"policies\": [{\"children\": [{\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc height\", \"id\": 0, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"486\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc-ish height\", \"id\": 1, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"480\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"half-ntsc height\", \"id\": 2, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"240\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"I like frame heights like 240, 480, 486\", \"id\": 2, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 3, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}, {\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 4, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"30000\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 5, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1001\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"NTSC 4EVA\", \"id\": 4, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 6, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"2997\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 7, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"100\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Or Fake NTSC\", \"id\": 5, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 8, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"25\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 9, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"PAL, why not\", \"id\": 6, \"kind\": \"XSLT\", \"parent_id\": 3}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"These are the framerates that I trust\", \"id\": 3, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"children\": [{\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 10, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"720\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 11, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"640\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 12, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"Frames widths like 720, 640, and 320 are nice\", \"id\": 7, \"kind\": \"XSLT\", \"parent_id\": 1}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Does this use framesize and framerates that I like?\", \"id\": 1, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"children\": [{\"ope\": \"<=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 13, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.5\"}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 14, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"In my aspect ratio zone?\", \"id\": 8, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 15, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\", \"type\": \"or\", \"name\": \"Do I like these frames?\", \"id\": 0, \"kind\": \"XSLT\", \"parent_id\": -1},{\"type\": \"or\", \"id\": 9, \"description\": \"changed description\", \"parent_id\": -1, \"name\": \"changed name\", \"kind\": \"XSLT\", \"is_system\": false, \"children\":[]},{\"type\": \"and\", \"id\": 10, \"description\": \"\", \"parent_id\": -1, \"name\": \"New policy 1\", \"kind\": \"XSLT\", \"is_system\": false, \"children\":[]}]}}" "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?format=JSTREE" "{\"POLICY_GET_POLICIES_RESULT\": \"{\\\"policiesTree\\\":[{\\\"id\\\":\\\"u_p\\\",\\\"text\\\":\\\"User policies\\\",\\\"type\\\":\\\"up\\\",\\\"state\\\":{\\\"opened\\\":true,\\\"selected\\\":true},\\\"children\\\":[{\\\"text\\\":\\\"changed name (or)\\\",\\\"type\\\":\\\"u\\\",\\\"data\\\":{\\\"policyId\\\":9,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"changed description\\\"},\\\"children\\\":[]},{\\\"text\\\":\\\"New policy 1 (and)\\\",\\\"type\\\":\\\"u\\\",\\\"data\\\":{\\\"policyId\\\":10,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[]}]},{\\\"id\\\":\\\"s_p\\\",\\\"text\\\":\\\"System policies\\\",\\\"type\\\":\\\"sp\\\",\\\"state\\\":{\\\"opened\\\":true},\\\"children\\\":[{\\\"text\\\":\\\"Do I like these frames? (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":0,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\\\"},\\\"children\\\":[{\\\"text\\\":\\\"Does this use framesize and framerates that I like? (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":1,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"I like frame heights like 240, 480, 486 (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":2,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"ntsc height\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":0,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Height\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"486\\\"}},{\\\"text\\\":\\\"ntsc-ish height\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":1,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Height\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"480\\\"}},{\\\"text\\\":\\\"half-ntsc height\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":2,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Height\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"240\\\"}}]},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":3,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"320\\\"}},{\\\"text\\\":\\\"These are the framerates that I trust (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":3,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"NTSC 4EVA (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":4,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":4,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Num\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"30000\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":5,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Den\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"1001\\\"}}]},{\\\"text\\\":\\\"Or Fake NTSC (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":5,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":6,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Num\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"2997\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":7,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Den\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"100\\\"}}]},{\\\"text\\\":\\\"PAL, why not (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":6,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":8,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Num\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"25\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":9,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Den\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"1\\\"}}]}]},{\\\"text\\\":\\\"Frames widths like 720, 640, and 320 are nice (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":7,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":10,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"720\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":11,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"640\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":12,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"320\\\"}}]}]},{\\\"text\\\":\\\"In my aspect ratio zone? (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":8,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":13,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"DisplayAspectRatio\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"<=\\\",\\\"value\\\":\\\"1.5\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":14,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"DisplayAspectRatio\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\">=\\\",\\\"value\\\":\\\"1.0\\\"}}]},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":15,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"DisplayAspectRatio\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\">=\\\",\\\"value\\\":\\\"1.0\\\"}}]}]}]}\"}" "pass get policies jstree"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_names_list" '{"POLICY_GET_POLICIES_NAMES_LIST_RESULT": {"policies": [{"id": 0, "name": "Do I like these frames?"},{"name": "changed name", "id": 9},{"id": 10, "name": "New policy 1"}]}}' "pass get policies_names_list"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?id=10" '{"POLICY_GET_POLICIES_RESULT": {"policies": [{"type": "and", "id": 10, "description": "", "kind": "XSLT", "parent_id": -1, "name": "New policy 1", "is_system": false, "children":[]}]}}' "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get?id=9&format=JSTREE" '{"POLICY_GET_RESULT": "{\"policyTree\":{\"text\":\"changed name (or)\",\"type\":\"u\",\"data\":{\"policyId\":9,\"kind\":\"XSLT\",\"type\":\"or\",\"isEditable\":true,\"description\":\"changed description\"},\"children\":[]}}"}' "pass get policy jstree"

#clear policies
test_with_curl "http://0.0.0.0:4242/1.7/policy_clear_policies" '{"POLICY_CLEAR_POLICIES_RESULT": {}}' "pass clear policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies" "{\"POLICY_GET_POLICIES_RESULT\": {\"policies\": [{\"children\": [{\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc height\", \"id\": 0, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"486\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"ntsc-ish height\", \"id\": 1, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"480\"}, {\"ope\": \"=\", \"field\": \"Height\", \"name\": \"half-ntsc height\", \"id\": 2, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"240\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"I like frame heights like 240, 480, 486\", \"id\": 2, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 3, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}, {\"children\": [{\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 4, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"30000\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 5, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1001\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"NTSC 4EVA\", \"id\": 4, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 6, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"2997\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 7, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"100\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Or Fake NTSC\", \"id\": 5, \"kind\": \"XSLT\", \"parent_id\": 3}, {\"children\": [{\"ope\": \"=\", \"field\": \"FrameRate_Num\", \"name\": \"\", \"id\": 8, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"25\"}, {\"ope\": \"=\", \"field\": \"FrameRate_Den\", \"name\": \"\", \"id\": 9, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"PAL, why not\", \"id\": 6, \"kind\": \"XSLT\", \"parent_id\": 3}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"These are the framerates that I trust\", \"id\": 3, \"kind\": \"XSLT\", \"parent_id\": 1}, {\"children\": [{\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 10, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"720\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 11, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"640\"}, {\"ope\": \"=\", \"field\": \"Width\", \"name\": \"\", \"id\": 12, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"320\"}], \"is_system\": true, \"description\": \"\", \"type\": \"or\", \"name\": \"Frames widths like 720, 640, and 320 are nice\", \"id\": 7, \"kind\": \"XSLT\", \"parent_id\": 1}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"Does this use framesize and framerates that I like?\", \"id\": 1, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"children\": [{\"ope\": \"<=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 13, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.5\"}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 14, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"\", \"type\": \"and\", \"name\": \"In my aspect ratio zone?\", \"id\": 8, \"kind\": \"XSLT\", \"parent_id\": 0}, {\"ope\": \">=\", \"field\": \"DisplayAspectRatio\", \"name\": \"\", \"id\": 15, \"occurrence\": 1, \"tracktype\": \"Video\", \"value\": \"1.0\"}], \"is_system\": true, \"description\": \"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\", \"type\": \"or\", \"name\": \"Do I like these frames?\", \"id\": 0, \"kind\": \"XSLT\", \"parent_id\": -1}]}}" "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 1}}' "pass get policies count"

JSON_DATA=`cat ./data/sample_policy_1.xml | sed 's/"/\\\\"/g' | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n//g'`

#import and remove
# import file has 8 policies & 16 rules
test_with_curl_data "http://0.0.0.0:4242/1.7/policy_import" "{\"POLICY_IMPORT\": {\"xml\": \"$JSON_DATA\"}}" '{"POLICY_IMPORT_RESULT": {"id": 11}}' "pass import policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_remove?id=11" '{"POLICY_REMOVE_RESULT": {}}' "pass remove policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 1}}' "pass get policies count"

# dump and duplicate
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create" '{"XSLT_POLICY_CREATE_RESULT": {"id": 20}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_dump?id=20" '{"POLICY_DUMP_RESULT": {"xml": "<?xml version=\"1.0\"?>\n<policy type=\"and\" name=\"New policy\"/>\n"}}' "pass dump policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_duplicate?id=20" '{"POLICY_DUPLICATE_RESULT": {"id": 21}}' "pass duplicate policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_remove?id=20" '{"POLICY_REMOVE_RESULT": {}}' "pass remove policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?id=21" '{"POLICY_GET_POLICIES_RESULT": {"policies": [{"type": "and", "id": 21, "description": "", "parent_id": -1, "kind": "XSLT", "name": "New policy_copy", "is_system": false, "children":[]}]}}' "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_remove?id=21" '{"POLICY_REMOVE_RESULT": {}}' "pass remove policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 1}}' "pass get policies count"
test_with_curl "http://0.0.0.0:4242/1.7/policy_clear_policies" '{"POLICY_CLEAR_POLICIES_RESULT": {}}' "pass clear policies"

# XSLT policy rule operations
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create" '{"XSLT_POLICY_CREATE_RESULT": {"id": 22}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_create?policy_id=22" '{"XSLT_POLICY_RULE_CREATE_RESULT": {"id": 32}}' "pass create new xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_get?policy_id=22&id=32" '{"XSLT_POLICY_RULE_GET_RESULT": {"rule": {"field": "", "id": 32, "occurrence": -1, "name": "New Rule", "ope": "", "tracktype": "", "value": ""}}}' "pass get xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_duplicate?policy_id=22&id=32" '{"XSLT_POLICY_RULE_DUPLICATE_RESULT": {"id": 33}}' "pass duplicate xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_get?policy_id=22&id=33" '{"XSLT_POLICY_RULE_GET_RESULT": {"rule": {"field": "", "id": 33, "occurrence": -1, "name": "New Rule_copy", "ope": "", "tracktype": "", "value": ""}}}' "pass get xslt policy rule"
test_with_curl_data "http://0.0.0.0:4242/1.7/xslt_policy_rule_edit" "{\"XSLT_POLICY_RULE_EDIT\": {\"policy_id\":22, \"rule\": {\"field\": \"Format\", \"id\": 33, \"occurrence\": -1, \"name\": \"General Format is Matroska\", \"ope\": \"is_equal\", \"tracktype\": \"General\", \"value\": \"Matroska\"}}}" '{"XSLT_POLICY_RULE_EDIT_RESULT": {}}' "pass xslt policy rule edit"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_get?policy_id=22&id=33" '{"XSLT_POLICY_RULE_GET_RESULT": {"rule": {"field": "Format", "id": 33, "occurrence": -1, "name": "General Format is Matroska", "ope": "is_equal", "tracktype": "General", "value": "Matroska"}}}' "pass get xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?id=22&format=JSTREE" '{"POLICY_GET_POLICIES_RESULT": "{\"policiesTree\":[{\"id\":\"u_p\",\"text\":\"User policies\",\"type\":\"up\",\"state\":{\"opened\":true,\"selected\":true},\"children\":[{\"text\":\"New policy (and)\",\"type\":\"u\",\"data\":{\"policyId\":22,\"kind\":\"XSLT\",\"type\":\"and\",\"isEditable\":true,\"description\":\"\"},\"children\":[{\"text\":\"New Rule\",\"type\":\"r\",\"data\":{\"ruleId\":32,\"tracktype\":\"\",\"field\":\"\",\"occurrence\":-1,\"ope\":\"\",\"value\":\"\"}},{\"text\":\"General Format is Matroska\",\"type\":\"r\",\"data\":{\"ruleId\":33,\"tracktype\":\"General\",\"field\":\"Format\",\"occurrence\":-1,\"ope\":\"is_equal\",\"value\":\"Matroska\"}}]}]},{\"id\":\"s_p\",\"text\":\"System policies\",\"type\":\"sp\",\"state\":{\"opened\":true},\"children\":[]}]}"}' "pass get policies jstree"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?id=22" '{"POLICY_GET_POLICIES_RESULT": {"policies":[{"name": "New policy", "description": "", "parent_id": -1, "id": 22, "kind": "XSLT", "is_system": false, "type": "and", "children":[{"ope": "", "field": "", "name": "New Rule", "id": 32, "occurrence": -1, "tracktype": "", "value": ""},{"ope": "is_equal", "field": "Format", "name": "General Format is Matroska", "id": 33, "occurrence": -1, "tracktype": "General", "value": "Matroska"}]}]}}' "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get?id=22" '{"POLICY_GET_RESULT": {"policy":{"name": "New policy", "description": "", "parent_id": -1, "id": 22, "kind": "XSLT", "is_system": false, "type": "and", "children":[{"ope": "", "field": "", "name": "New Rule", "id": 32, "occurrence": -1, "tracktype": "", "value": ""},{"ope": "is_equal", "field": "Format", "name": "General Format is Matroska", "id": 33, "occurrence": -1, "tracktype": "General", "value": "Matroska"}]}}}' "pass get policy"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_delete?policy_id=22&id=32" '{"XSLT_POLICY_RULE_DELETE_RESULT": {}}' "pass delete xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_delete?policy_id=22&id=33" '{"XSLT_POLICY_RULE_DELETE_RESULT": {}}' "pass delete xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_rule_delete?policy_id=22&id=32" '{"XSLT_POLICY_RULE_DELETE_RESULT": {"nok": {"error": "Policy rule does not exist"}}}' "pass delete unexisting xslt policy rule"
test_with_curl "http://0.0.0.0:4242/1.7/policy_remove?id=22" '{"POLICY_REMOVE_RESULT": {}}' "pass remove policy"

# create XSLT policies with parent id
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create?user=5" '{"XSLT_POLICY_CREATE_RESULT": {"id": 23}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create?user=5&type=or&parent_id=23" '{"XSLT_POLICY_CREATE_RESULT": {"id": 24}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get?user=5&id=24" '{"POLICY_GET_RESULT": {"policy": {"type": "or", "id": 24, "description": "", "parent_id": 23, "name": "New policy 1", "kind": "XSLT", "is_system": false, "children":[]}}}' "pass get policies"
test_with_curl "http://0.0.0.0:4242/1.7/policy_remove?user=5&id=23" '{"POLICY_REMOVE_RESULT": {}}' "pass remove policy"

#check everything is clean
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 1}}' "pass get policies count"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies?user=1&format=JSTREE" "{\"POLICY_GET_POLICIES_RESULT\": \"{\\\"policiesTree\\\":[{\\\"id\\\":\\\"u_p\\\",\\\"text\\\":\\\"User policies\\\",\\\"type\\\":\\\"up\\\",\\\"state\\\":{\\\"opened\\\":true,\\\"selected\\\":true},\\\"children\\\":[]},{\\\"id\\\":\\\"s_p\\\",\\\"text\\\":\\\"System policies\\\",\\\"type\\\":\\\"sp\\\",\\\"state\\\":{\\\"opened\\\":true},\\\"children\\\":[{\\\"text\\\":\\\"Do I like these frames? (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":0,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"NTSC is nice, so is PAL, also 320x240 cuz it's my sample file\\\"},\\\"children\\\":[{\\\"text\\\":\\\"Does this use framesize and framerates that I like? (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":1,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"I like frame heights like 240, 480, 486 (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":2,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"ntsc height\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":0,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Height\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"486\\\"}},{\\\"text\\\":\\\"ntsc-ish height\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":1,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Height\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"480\\\"}},{\\\"text\\\":\\\"half-ntsc height\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":2,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Height\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"240\\\"}}]},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":3,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"320\\\"}},{\\\"text\\\":\\\"These are the framerates that I trust (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":3,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"NTSC 4EVA (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":4,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":4,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Num\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"30000\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":5,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Den\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"1001\\\"}}]},{\\\"text\\\":\\\"Or Fake NTSC (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":5,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":6,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Num\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"2997\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":7,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Den\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"100\\\"}}]},{\\\"text\\\":\\\"PAL, why not (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":6,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":8,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Num\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"25\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":9,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"FrameRate_Den\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"1\\\"}}]}]},{\\\"text\\\":\\\"Frames widths like 720, 640, and 320 are nice (or)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":7,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"or\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":10,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"720\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":11,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"640\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":12,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"Width\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"=\\\",\\\"value\\\":\\\"320\\\"}}]}]},{\\\"text\\\":\\\"In my aspect ratio zone? (and)\\\",\\\"type\\\":\\\"s\\\",\\\"data\\\":{\\\"policyId\\\":8,\\\"kind\\\":\\\"XSLT\\\",\\\"type\\\":\\\"and\\\",\\\"isEditable\\\":true,\\\"description\\\":\\\"\\\"},\\\"children\\\":[{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":13,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"DisplayAspectRatio\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\"<=\\\",\\\"value\\\":\\\"1.5\\\"}},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":14,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"DisplayAspectRatio\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\">=\\\",\\\"value\\\":\\\"1.0\\\"}}]},{\\\"text\\\":\\\"\\\",\\\"type\\\":\\\"r\\\",\\\"data\\\":{\\\"ruleId\\\":15,\\\"tracktype\\\":\\\"Video\\\",\\\"field\\\":\\\"DisplayAspectRatio\\\",\\\"occurrence\\\":1,\\\"ope\\\":\\\">=\\\",\\\"value\\\":\\\"1.0\\\"}}]}]}]}\"}" "pass get policies jstree"

#import, add child and remove
# import file has 8 policies & 16 rules
test_with_curl_data "http://0.0.0.0:4242/1.7/policy_import" "{\"POLICY_IMPORT\": {\"user\":5, \"xml\": \"$JSON_DATA\"}}" '{"POLICY_IMPORT_RESULT": {"id": 25}}' "pass import policy"
test_with_curl "http://0.0.0.0:4242/1.7/xslt_policy_create?user=5&type=or&parent_id=26" '{"XSLT_POLICY_CREATE_RESULT": {"id": 34}}' "pass create new policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_remove?user=5&id=25" '{"POLICY_REMOVE_RESULT": {}}' "pass remove policy"
test_with_curl "http://0.0.0.0:4242/1.7/policy_get_policies_count?user=5" '{"POLICY_GET_POLICIES_COUNT_RESULT": {"size": 1}}' "pass get policies count"
